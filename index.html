<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quest 3 VR Shooter</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden;
    background: black; color: white; font-family: monospace;
  }
  #overlay {
    position: absolute; top: 10px; left: 10px;
    background: rgba(0,0,0,0.6); padding: 10px 15px; border-radius: 8px;
    z-index: 9999;
    user-select: none;
  }
  #enterVR {
    margin-top: 8px;
    padding: 10px 18px;
    font-size: 1.2em;
    background: #0078ff;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="overlay">
  Score: <span id="score">0</span><br />
  <button id="enterVR">Enter VR</button>
  <div id="msg" style="margin-top:8px; font-size:0.9em;"></div>
</div>

<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three';
import { XRControllerModelFactory } from 'https://cdn.skypack.dev/three/examples/jsm/webxr/XRControllerModelFactory.js';

const scoreEl = document.getElementById('score');
const enterVRBtn = document.getElementById('enterVR');
const msgEl = document.getElementById('msg');

let scene, camera, renderer;
let controller, controllerGrip;
let enemies = [];
let bullets = [];
let score = 0;

function logMessage(msg) {
  msgEl.textContent = msg;
  console.log(msg);
}

async function checkXR() {
  if (!navigator.xr) {
    logMessage('WebXR not available in this browser.');
    enterVRBtn.disabled = true;
    return false;
  }
  const supported = await navigator.xr.isSessionSupported('immersive-vr');
  if (!supported) {
    logMessage('immersive-vr not supported.');
    enterVRBtn.disabled = true;
    return false;
  }
  logMessage('immersive-vr supported! Ready to enter VR.');
  enterVRBtn.disabled = false;
  return true;
}

function initScene() {
  scene = new THREE.Scene();

  // Skybox for environment
  const loader = new THREE.CubeTextureLoader();
  const envMap = loader.load([
    'https://threejs.org/examples/textures/cube/skybox/px.jpg',
    'https://threejs.org/examples/textures/cube/skybox/nx.jpg',
    'https://threejs.org/examples/textures/cube/skybox/py.jpg',
    'https://threejs.org/examples/textures/cube/skybox/ny.jpg',
    'https://threejs.org/examples/textures/cube/skybox/pz.jpg',
    'https://threejs.org/examples/textures/cube/skybox/nz.jpg',
  ]);
  scene.background = envMap;

  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 1.6, 3);

  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444);
  hemiLight.position.set(0, 20, 0);
  scene.add(hemiLight);

  const dirLight = new THREE.DirectionalLight(0xffffff);
  dirLight.position.set(3, 10, 10);
  scene.add(dirLight);

  const floorGeo = new THREE.PlaneGeometry(30, 30);
  const floorMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
  const floor = new THREE.Mesh(floorGeo, floorMat);
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);

  controller = renderer.xr.getController(0);
  controller.addEventListener('select', shoot);
  scene.add(controller);

  const controllerModelFactory = new XRControllerModelFactory();
  controllerGrip = renderer.xr.getControllerGrip(0);
  controllerGrip.add(controllerModelFactory.createControllerModel(controllerGrip));
  scene.add(controllerGrip);

  enemies = [];
  bullets = [];
  score = 0;
  scoreEl.textContent = '0';

  for (let i = 0; i < 12; i++) {
    const enemy = new THREE.Mesh(
      new THREE.BoxGeometry(0.5, 0.5, 0.5),
      new THREE.MeshStandardMaterial({ color: 0xff0000 })
    );
    enemy.position.set(
      (Math.random() - 0.5) * 20,
      0.25,
      (Math.random() - 0.5) * 20 - 5
    );
    scene.add(enemy);
    enemies.push(enemy);
  }
}

function shoot() {
  const bullet = new THREE.Mesh(
    new THREE.SphereGeometry(0.03, 8, 8),
    new THREE.MeshBasicMaterial({ color: 0xffff00 })
  );
  bullet.position.setFromMatrixPosition(controller.matrixWorld);

  const direction = new THREE.Vector3(0, 0, -1).applyQuaternion(controller.quaternion);
  bullet.userData.velocity = direction.multiplyScalar(0.5);

  scene.add(bullet);
  bullets.push(bullet);
}

function animate() {
  renderer.setAnimationLoop(() => {
    bullets.forEach((bullet, i) => {
      bullet.position.add(bullet.userData.velocity);

      enemies.forEach((enemy, j) => {
        if (enemy && bullet.position.distanceTo(enemy.position) < 0.5) {
          scene.remove(enemy);
          enemies[j] = null;
          scene.remove(bullet);
          bullets.splice(i, 1);
          score += 10;
          scoreEl.textContent = score;
        }
      });

      if (bullet.position.length() > 50) {
        scene.remove(bullet);
        bullets.splice(i, 1);
      }
    });

    renderer.render(scene, camera);
  });
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

async function startXRSession() {
  try {
    const session = await navigator.xr.requestSession('immersive-vr', {
      optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking'],
    });
    renderer.xr.setSession(session);
    enterVRBtn.style.display = 'none';
    initScene();
    animate();
  } catch (err) {
    logMessage('Failed to start VR session: ' + err.message);
  }
}

function init() {
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  window.addEventListener('resize', onWindowResize);

  checkXR();

  enterVRBtn.addEventListener('click', () => {
    startXRSession();
  });
}

init();

</script>
</body>
</html>

